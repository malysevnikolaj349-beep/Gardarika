GARDARIKA — CODEX IMPLEMENTATION CONTRACT v1.0
(Единый “контракт”, чтобы генератор кода не импровизировал)

Дата: 2025-12-23
Язык: русский
Стиль текста в игре: “древнерусский, аккуратно”, без перебора (в админке есть подсказчик стиля).

============================================================
0) ЦЕЛЬ ДОКУМЕНТА
============================================================
Этот файл — источник истины (SoT) для кодогенерации. Следовать строго.
Если что-то не определено — НЕ додумывать, а оставлять TODO/заглушку.

============================================================
1) NON-NEGOTIABLES (НЕЛЬЗЯ МЕНЯТЬ)
============================================================

1.1 Telegram-бот: UI/UX
1) Взаимодействие с миром происходит НА КАРТЕ (движение, бой, NPC, квесты, торговля).
2) Главное меню бота содержит ТОЛЬКО: Профиль героя, Инвентарь, Карта (текущая 16×16), Княжество (кнопка всегда доступна), VIP, Настройки, минимально необходимое.
3) НЕЛЬЗЯ реализовать переходы между локациями через меню — только через карту.
4) НЕЛЬЗЯ переносить бои/НПС/квесты в “разделы меню” — только через карту.

1.2 Мир и карта
5) Мир состоит из локаций 16×16 (“чанков”).
6) Есть глобальная карта с биомами; каждая локация имеет world_x/world_y.
7) Переход в соседнюю локацию возможен только стоя у края 16×16 и нажимая направление (←↑→↓).
8) Переходы, путешествия, крафт, строительство — по таймерам (реальное время). Энергия для путешествий/крафта НЕ используется.
9) Safe-zones: город новичков/города/иные безопасные зоны. В safe-zones PvP запрещён.
10) Вне городов PvP разрешён, но территории княжеств могут задавать локальные правила.

1.3 Бой
11) Бой пошаговый.
12) Бой начинается и ведётся на клетке карты (в рамках “режима боя”), без вынесения в главное меню.
13) Навыки имеют: стоимость энергии, КД, эффекты (бафы/дебафы/контроль).
14) Энергия:
    - тратится только в бою,
    - НЕ регенится в бою,
    - перед каждым новым боем ВСЕГДА полная (energy = energy_max на старт боя).
15) Эффекты включают минимум: стан 1–2 хода, пропуск хода, страх (шанс пропуска), кровотечение, ослабления/усиления.
16) Бой может происходить: PvE (с мобом) и PvP (с игроком), где разрешено правилами.

1.4 PK / смерть / лут
17) В стартовой локации новичков PvP запрещён полностью.
18) В городах PvP запрещён полностью (safe).
19) При смерти игрок теряет часть добычи/лутов.
20) НЕ все предметы, выпавшие с игрока, видны убийце.
21) Часть предметов может остаться на земле и быть подобрана мобами.
22) У мобов есть:
    - фиксированный дроп,
    - плюс “подобранные предметы”, которые тоже могут выпасть при убийстве моба.

1.5 Мобы и боссы (персистентные)
23) HP мобов/боссов НЕ восстанавливается между боями. Моб остаётся с тем же hp_current.
24) Мобы и боссы мигрируют по карте (включая переходы между локациями).
25) Мобы и боссы НЕ заходят в safe-zones (города/новичковые/прочие).
26) Моб может подбирать предметы с земли и “нести/использовать” их.
27) Моб может прокачиваться (уровень/параметры) побеждая игроков (ограниченно).
28) Для “важных мобов/боссов” используются уникальные имена.

1.6 Княжества, города, налоги
29) Вместо гильдий — княжества (политико-экономические образования).
30) Княжества контролируют территории (локации) и города, задают правила на своих землях.
31) Если бой произошёл на чужой территории, часть ценности лута идёт как налог в казну контролирующего княжества.
32) Города:
    - нельзя уничтожить полностью,
    - максимум состояние “руины”.
33) Состояния города: процветает / ослаблен / разорён / руины.
34) Владение городом может изменяться: захватом, покупкой права управления (особенно руины), мятежом.
35) Внутри города возможны мятежи (жители как фактор).

1.7 Родной город (место рождения)
36) У каждого игрока есть родной город (home_city) — место рождения.
37) Первые игроки спавнятся в городе новичков.
38) Города княжеств могут “открыть рождение” (spawn_enabled), и новые игроки могут выбирать город рождения.
39) Родной город влияет:
    - на стартовые бонусы,
    - на сюжет на всю жизнь персонажа.
40) Родной город отображается в профиле.

1.8 Админка (Web Admin)
41) Помимо бота есть веб-админка.
42) В админке RBAC роли: Owner/SuperAdmin, GM, Moderator, Economy Manager, Content Designer.
43) Админка разделена на страницы по блокам (без свалки функций на одном экране).
44) Обязательные визуальные редакторы: карта 16×16, квесты, диалоги.
45) В редакторах текстов есть помощник стиля “древнерусский аккуратно” (подсказки/замены/проверка).
46) Доступ админов выдаётся Owner по Telegram ID (tg_id). Пароли НЕ используются.
47) Вход в админку происходит через Telegram WebApp (inline web-app кнопка): обычным игрокам кнопка недоступна.
48) Сервер админки валидирует Telegram WebApp initData и сверяет tg_id с admin_users. Без Telegram WebApp initData доступ запрещён.
49) У Owner есть страница выдачи ролей: выбрать роль + ввести tg_id + выдать доступ.
50) У Owner есть режим “войти как админ” (impersonation) для проверки интерфейса и прав; обязательно логировать actor и as_user.
51) Любое админ-действие пишет audit log (кто/что/когда/старое/новое/причина). Опасные действия — через approvals (настраивается).

============================================================
2) FORBIDDEN ASSUMPTIONS (ЧЕГО НЕЛЬЗЯ “ДОДУМЫВАТЬ”)
============================================================
A) Нельзя вводить реген энергии в бою.
B) Нельзя делать “энергию” для путешествий/крафта.
C) Нельзя автолечить мобов между боями.
D) Нельзя делать боссов неподвижными по умолчанию (они мигрируют).
E) Нельзя разрешать мобам заходить в safe-zones.
F) Нельзя давать всем игрокам кнопку админки.
G) Нельзя делать логин админки по паролю/почте.
H) Нельзя переносить бои/НПС/квесты в меню вместо карты.
I) Нельзя делать города полностью уничтожаемыми.

============================================================
3) IMPLEMENTATION CONTRACT (ЧТО ИМЕННО НУЖНО СДЕЛАТЬ)
============================================================

3.1 Минимальный доменный слой (Game Core)
- Единственная бизнес-логика для бота и админки.
- Все изменения состояния мира проходят через доменные команды (не прямые правки БД из UI).

3.2 Ключевые сущности (минимально необходимые поля)
(Если какие-то поля не нужны в MVP — можно оставить NULL, но сущности и связи сохранять.)

Players
- tg_id (unique), player_id
- home_city_id
- current_location_id, x, y
- hp, hp_max
- level, xp
- fame, fear

World / Locations
- location_id, world_x, world_y, biome
- owner_principality_id (nullable)
- is_safe_zone
- pvp_policy / tax_policy (или refs)

Location Cells (16×16)
- location_id, x, y, terrain_type, flags_json
- cell_objects: location_id, x, y, type, ref_id, params_json

Cities
- city_id, name, location_id, owner_principality_id
- state (prosper/weakened/raided/ruins)
- spawn_enabled, spawn_capacity
- population: loyalty/fear/satisfaction/population

Principalities
- principality_id, name
- members: player_id, rank
- territory_control: location_id, principality_id, influence(0..100), state(controlled/contested/neutral)
- treasury_ledger (двойная запись/учёт)

Combat / Battles
- battle_id, location_id,x,y, type(pve/pvp), turn, state
- battle_effects (stun/fear/bleed/…)
- skills (defs), cooldown tracking

Loot
- ground_loot_piles: location_id,x,y, visibility_mode(public/killer_only/hidden), expires_at
- ground_loot_items: pile_id -> item_instance_id

Items / Inventory
- item_defs, item_instances
- inventories(owner_type, owner_id, slot/container, item_instance_id, qty)

Mobs
- mob_defs (base stats, is_boss, is_important, fixed_drop_table)
- mob_instances: mob_def_id, unique_name, location_id,x,y, hp_current, level_current, state, respawn_at

Espionage
- spy_ops: actor_player_id, target_type/id, op_type, started_at, resolve_at, state, result_json
- counterintel: city/principality level + sources

Economy
- city_stocks(city_id, item_def_id, stock, target_stock, base_price, k)
- market_orders, market_trades
- caravans(from_city,to_city, route_json, depart_at, arrive_at, state, cargo_inventory)

Admin
- admin_users(tg_id, role_id, is_active, last_login_at)
- roles/permissions/role_permissions, overrides
- admin_audit_log(actor_tg_id, as_tg_id, action, target, before_json, after_json, reason, created_at)
- approvals queue (для опасных операций) — если включено

3.3 Движение и переходы (Telegram)
- MoveWithinLocation: шаг по клеткам (0..15)
- TransitionToNeighborLocation: только у края; таймер; после таймера новая location_id и корректный x/y на входе

3.4 Бой (минимальная спецификация)
- StartBattle(player vs mob/player) на клетке
- На старте боя energy = energy_max (не хранить как длительную шкалу вне боя)
- Skill use:
  - проверка КД
  - проверка энергии
  - применение эффекта
- End turn: уменьшение длительности эффектов
- Resolve: death, loot split, tax

3.5 Налог с боёв
- При завершении боя на чужой территории:
  - вычислить loot_value (по базовой оценке, не по рыночной)
  - tax = min(tax_cap, loot_value * tax_pct)
  - отправить tax в treasury_ledger владельца территории

3.6 Персистентные мобы
- HP не восстанавливается.
- Миграция: событийная (при входе игрока в локацию, конце боя, по редкому таймеру “при обращении”).
- Подбор лута: моб может подбирать pile с visibility hidden/public.
- Важно: моб не мигрирует в safe-zones (проверка при выборе клетки/локации).

3.7 Города и “неуничтожимость”
- Город всегда остаётся сущностью. Можно менять:
  - owner
  - state (до ruins)
  - population параметры
- Город в ruins может быть:
  - захвачен
  - куплен (смена owner)
  - восстановлен через ресурсы/таймеры (детально позже)

3.8 Родной город и спавн новичков
- При создании персонажа:
  - если нет доступных player-cities для рождения — родной город = city новичков
  - иначе предоставить выбор среди spawn_enabled городов
- home_city сохраняется навсегда; влияет на сюжет (условия квестов/диалогов).

3.9 Админка: авторизация и выдача ролей
- Owner выдаёт роли, вводя tg_id.
- Кнопка админки (WebApp) показывается в боте только admin_users.is_active == true.
- Админка backend:
  - принимает initData от Telegram WebApp
  - валидирует подпись
  - извлекает tg_id
  - проверяет admin_users
  - выдаёт сессию и RBAC

3.10 Визуальные редакторы (обязательные)
- Location 16×16 editor:
  - terrain слой
  - objects слой (NPC/resource/mob spawns, правила)
- Dialog tree editor:
  - nodes/options
  - conditions/actions
- Quest editor:
  - steps/types
  - conditions/rewards
- Все редакторы: Draft → Publish + versioning + rollback.
- Встроенный “стилист древнерусского”: подсказки/замены/проверка (минимум: словарь + подсветка).

============================================================
4) ACCEPTANCE TESTS (ПРОВЕРОЧНЫЕ СЦЕНАРИИ)
============================================================

A) UI/Map
1) Игрок не может перейти в другую локацию через меню — только у края 16×16.
2) NPC/бои/квесты доступны из карты, а не из главного меню.

B) Energy/Combat
3) В начале каждого боя энергия равна energy_max.
4) Энергия не восстанавливается в ходе боя.
5) Навык нельзя нажать при КД>0 или при недостатке энергии.
6) Стан заставляет пропустить ход(ы) строго на указанное число.

C) Persistent mobs
7) Игрок оставил моба на 20% HP → другой игрок начинает бой с тем же mob.hp_current.
8) Моб не мигрирует в город/safe-zone (проверка).
9) Моб подобрал предмет с земли → при убийстве моба предмет может выпасть.

D) Loot visibility
10) После смерти игрока часть предметов видна убийце, часть падает на землю, часть hidden (не видна), но мобы могут подобрать.
11) Убийца не видит “hidden” предметы.

E) Tax
12) Бой на чужой территории: налог уходит в казну владельца территории.
13) Бой на своей территории: налог не удерживается (если правила не задают иначе).
14) Налог не превышает tax_cap.

F) Cities
15) Город нельзя удалить из базы/мира; максимум state=ruins.
16) City state меняется ступенчато; owner может меняться.

G) Home city
17) При создании игрока home_city фиксируется и виден в профиле.
18) Если city.spawn_enabled включён, новый игрок может выбрать его как родной город.

H) Admin
19) Обычный игрок не видит кнопку админки.
20) Админ заходит в админку только через Telegram WebApp initData; прямой заход по ссылке вне Telegram запрещён.
21) Owner может выдать роль по tg_id.
22) Owner может “войти как админ” и увидеть интерфейс/права; действие логируется.
23) Любая админ-правка пишет audit log.

============================================================
5) MVP ROADMAP (КРАТКО)
============================================================
Release 1 (запуск):
- Telegram: карта 16×16 + переходы + PvE/PvP + лут + родной город + базовые NPC/квесты.
- Game Core: персистентные мобы (HP/миграция/подбор лута), налог с боёв, базовые княжества.
- Admin: RBAC+выдача ролей по tg_id, визуальный редактор карты, редактор квестов/диалогов (draft/publish), управление мобами, аудит.

Release 2 (глубина):
- Осады/войны, мятежи.
- Полная экономика (ордер-рынок, контракты), расширенный шпионаж/саботаж, дипломатия.

============================================================
6) NOTES FOR CODE GENERATO
R
============================================================
- Не выдумывать новые механики.
- Если неясно — TODO с вопросом.
- Делать простую реализацию MVP, но не нарушать non-negotiables.
